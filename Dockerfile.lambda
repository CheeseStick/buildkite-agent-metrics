FROM golang:1.17 AS build

# See https://github.com/buildkite/buildkite-agent-metrics/releases for latest version
ENV LAMBDA_VERSION="5.3.0" 

WORKDIR /app
COPY . /app

RUN apt-get update && apt-get install -y wget tar && \
    wget "https://github.com/buildkite/buildkite-agent-metrics/archive/refs/tags/v${LAMBDA_VERSION}.tar.gz" && \
    tar xvzf "v${LAMBDA_VERSION}.tar.gz" && \
    cd "buildkite-agent-metrics-${LAMBDA_VERSION}" && \
    go get ./lambda && \
    CGO_ENABLED=0 go build -o ../handler ./lambda

FROM public.ecr.aws/lambda/provided:al2

COPY --from=build /app/handler ${LAMBDA_TASK_ROOT}

ENTRYPOINT ["./handler"]
